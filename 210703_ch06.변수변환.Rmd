---
title: "Chapter06. 변수변환"
author: "Jeong-Eun Lee"
date: '2021 7 3 '
output: html_document
---
### 6.1 소개
+ 변수변환의 목적 : 선형성, 정규성, 분산의 안정화 등을 달성하기 위하여 실행 -> 표준적인 회귀의 가정 충족하도록 함
+ 분산 안정화변환 : 오차항이 등분산성을 가지도록 함 


### 6.2 선형성을 위한 변환들
+ 선형화 할 수 없는 단순한 비선형모형 : 수정지수곡선, 두 지수함수의 선형합 등


### 6.3 X-선 방사에 의한 박테리아 사망률
```{r}
x_bac = read.table("C:\\Users\\X-Note\\Desktop\\x-bac.txt", header = T)
head(x_bac)
```
+ 변수 : $n_t$ = 생존하는 박테리아의 수(100마리 단위), 
         $t$ = 노출시간
+ 이론 : 각 박테리아에는 하나의 생명중심체가 있고 이것이 X-선에 맞았을 때 그 박테리아는 죽게 되며, 생존한 박테리아 수의 로그값은 노출시간에 대해 직선적인 관계를 가진다.
+ 시간($t$)에 따라 생존하는 박테리아 수($n_t$)의 관계식 : $n_t = n_0e^{\beta_1t}, t>0$  
  + 여기에서 모수 $n_0$는 실험을 시작할 시점($t = 0$)에서의 박테리아 수이고, $\beta_1$은 감소율을 의미함.
+ 위의 식을 로그변환하면 
$$ln\,n_t = ln\,n_0 + \beta_1t = \beta_0 + \beta_1t$$ 
$$ln\,n_t = \beta_0 + \beta_1t + \epsilon_t$$

#### 6.3.1 선형모형의 부적절성
+ 단계 1) 원래 데이터에 대해 $n_t$ 대 $t$의 플롯 그리기 -> 시간($t$) 값이 큰 경우 선형성에서 상당히 벗어남 + 특이값 존재
```{r}
plot(x_bac$t, x_bac$N_t, xlab = "t", ylab = "n_t", pch = 16)
```

+ 단계 2) 원래 데이터에 대해 회귀적합 -> 회귀계수 유의, $R^2$값 높음(-> 유의하지 않는 이유)
```{r}
fit1 = lm(N_t ~ t, data = x_bac)
summary(fit1)
plot(rstandard(fit1), xlab = "t", ylab = "잔차", pch = 16)
```

#### 6.3.2) 선형성을 위한 로그변환
+ 단계 3) $n_t$에 로그변환한 데이터에 대해 $ln\,n_t$ 대 $t$의 플롯 그리기 -> 선형성을 띰
```{r}
plot(x_bac$t, log(x_bac$N_t),  xlab = "t", ylab = "ln n_t", pch = 16)
```

+ 단계 4) $n_t$에 로그변환한 데이터에 대해 회귀적합 -> 회귀계수 모두 유의, 표준오차 감소, $R^2 \approx 0.99$
```{r}
fit2 = lm(log(N_t) ~ t, data = x_bac)
summary(fit2) 
plot(rstandard(fit2), xlab = "t", ylab = "잔차", pch = 16)
```

  + $\beta_1$의 최소제곱추정치 = -0.218
  + $\beta_1$의 신뢰구간 : (-0.218 - 1.96 * 0.0066, -0.218 + 1.96 * 0.0066) = (-0.231, -0.205)
  + $\beta_1$은 $\beta_0$의 최량선형불편추정량(BLUE)
    + 최량선형불편추정량 : 최소제곱추정량들은 반응변수에 대한 관찰값들의 선형결합 꼴로 표현할 수 있는 모든 가능한 불편추정량들 중에서 최소분산을 가지는 경우
    
    
### 6.4 분산안정화 변환
+ 변수변환의 목적 : 오차항의 분산을 안정시켜 등분산성을 유지하는 것
+ 이분산성 : 오차항의 분산이 모든 관측값에 대하여 똑같은 상수항을 취하지 않을 경우 -> 이론적 타당성 x, 정확성 신뢰 x
  + ex) 잔차들의 변이가 X값에 따라서 점점 커지거나 작아지는 깔때기 형태의 분포를 가짐
+ 분산 안정화를 위한 변환들 : 포아송분포($\sqrt(Y)$), 이항분포($sin^{-1}(\sqrt(Y))$), 음이항($\lambda^{-1}sinh^{-1}(\lambda\sqrt(Y)$)


### 6.5 이분산성의 검출
+ 27개 제조회사의 종업원과 감독자의 수의 관계를 알아본다.
```{r}
factory = read.table("C:\\Users\\X-Note\\Desktop\\factory.txt", header = T)
head(factory)
plot(factory$X, factory$Y, xlab = "X", ylab = "Y", pch = 16)
fit3 = lm(Y ~ X, data = factory)
summary(fit3)
plot(rstandard(fit3), xlab = "X", ylab = "잔차", pch = 16)
```

+ X에 대한 표준화잔차플롯을 보면, X의 값이 증가함에 따라 표준화잔차들은 그 폭이 점차 커지는 띠 안에 포함되는 것으로 나타난다.

+ 표준화잔차플롯의 해석방법
  1) x의 증가에 따라 잔차들을 포함한 띠가 넓어지면 : x에 따라 오차항의 분산도 증가한다.
  2) x의 증가에 따라 잔차들을 포함한 띠가 좁아지면 : x에 따라 오차항의 분산도 감소한다.
  3) x의 증가에 따라 잔차들을 포함한 띠가 x축과 평행이면 : 이분산성에 대한 증거가 없다. -> 등분산 충족 -> 최소제곱추정에 대한 기본 가정이 만족
  

### 6.6 이분산성의 제거
```{r}
Y_1 = factory$Y/factory$X
X_1 = 1/factory$X
fit4 = lm(Y_1 ~ X_1, data = factory)
summary(fit4)   
plot(X_1, rstandard(fit4), xlab = "1/X", ylab = "잔차", pch = 16)
```

+ 원모형 $\hat{Y} = \hat{\beta_1'} + \hat{\beta_0'}X$를 변환모형 $y_i' = \beta_0' + \beta_1'x_i + \epsilon_i'$의 형태로 바꾸어 회귀 적합을 하니 표준화잔차플롯에서 이분산성에 대한 특별한 단서를 발견할 수 없어 즉 변환된 모형은 등분산성을 충족한다고 할 수 있다.

+ 표준화잔차플롯 출력 시 A에 대한 B의 회귀로부터의 조건에 대해서는 "plot(A, rstandard(fitB), ~ )"로 작성해야 인덱스가 아닌 A에 대한 플롯이 그려짐

### 6.4.+ 항공사 사상사고 데이터
+ 변수 : $Y$ - 사상사고 발생건수, $N$ - 항공편 운항률
````{r}
flight = read.table("C:\\Users\\X-Note\\Desktop\\flight.txt", header = T)
plot(flight$N, flight$Y, xlab = "N", ylab = "Y", pch = 16) 
fit5 = lm(Y ~ N, data = flight)
summary(fit5) 
plot(flight$N, rstandard(fit5), xlab = "N", ylab = "잔차", pch = 16)
```

+ 원모형 $y_i = \beta_0 + \beta_1n_i + \epsilon_i$ : $n_i$의 증가에 따라 잔차의 변화폭이 증가함 -> 이분산성 o, 등분산성 x

  이를 경험에 근거하여 포아송 변수에 대해 제곱근 변환을 수행하면
```{r}
fit6 = lm(sqrt(Y) ~ N, data = flight)
summary(fit6)
plot(flight$N, rstandard(fit6), xlab = "N", ylab = "잔차", pch = 16)
```

+ 변환모형 $\sqrt(y_i) = \beta_0' + \beta_1'n_i + \epsilon_i$ : $n_i$와 더불어 변환하는 양상을 보이지 않음 -> 등분산성 o, but 통계적으로 설명력($R^2$)이 떨어지므로 다른 요인을 모형에 고려할 필요가 있음

### 6.7 가중최소제곱법
+ 가중최소제곱(WLS) : 회귀모수들에 오차항의 분산에 반비례하는 가중값을 준 가중오차제곱합을 최소화하여 추정하는 것 

  -> $\sum(y_i - \beta_0 - \beta_1x_i)^2$

### 6.8 데이터에 대한 로그변환
+ 로그변환 : 원데이터를 그대로 사용하지 않고 로그변환을 취한 후에 분석을 시도하는 것
  + 분석 대상변수가 평균에 비해 큰 표준편차를 가진 경우 필요
  + 특징 : 변이를 무디게 함, 비대칭성을 줄임, 이분산성 제거
  + 문제점 : 0이나 음수값에 대해서는 적용이 안되어 다른 변환 방법이 필요함
  
  
+ 로그변환에 대한 예제
```{r}
plot(factory$X, log(factory$Y), xlab = "X", ylab = "ln Y", pch = 16)
fit7 = lm(log(Y) ~ X, data = factory)
summary(fit7)
plot(factory$X, rstandard(fit7), xlab = "X", ylab = "잔차", pch = 16)
```

+ X에 대한 ln Y의 회귀로부터 얻은 표준화잔차플롯을 보면 이분산성은 제거되었으나 잔차들이 2차곡선 모양을 보여 명백한 비선형성을 보인다.
+ 이와 같은 경우에는 $ln\,y_i = \beta_0 + \beta_1x_i + \beta_2x_i^2 + \epsilon_i$와 같은 모형이 더 적절할 수 있으므로 이 식을 적용해보겠다.
```{r}
X_2 = factory$X * factory$X
fit8 = lm(log(Y) ~ X + X_2, data = factory)
summary(fit8)
plot(factory$X, rstandard(fit8), xlab = "X", ylab = "잔차", pch = 16)
plot(X_2, rstandard(fit8), xlab = "X^2", ylab = "잔차", pch = 16)
```

+ 이차항을 포함하는 모형에서의 표준화잔차플롯에서는 이분산성이나 비선형성을 보이지 않아 좋은 모형이라고 할 수 있다.

### 연습문제 6.4
#### 바람 냉각의 요인 : 표 6.18은 정지 대기에서 잰 실제 온도(T)와 풍속(V)하에서 바람으로 인해 일어나는 냉각 효과가 반영된 체감 온도(W)를 나타내고 있다. 바람이 없는 상태(zero-wind condition)는 사람이 정지 대기에서 걸을 때 느끼는 냉기의 비율로 취해진다. 원래는 국립기상국에서 출가난 데이터이나, 여기에서는 Boston의 과학 박물관에서 출간한 것을 재편집하여 사용하고자 한다. 온도는 모두 화씨로 잰 것이며, 풍속은 시간당 마일(mph) 단위로 측정하였다.

(a) 표 6.18의 데이터는 회귀분석 프로그램에서 직접 사용하기에는 적절하지 않은 형태로 되어 있다. 따라서 변수 W, T, V에 대응하는 세 개의 열을 가지는 다른 데이터 표를 작성할 필요가 있다. 이 표는 이 책의 웹사이트에서 찾을 수 있다.
```{r}
setwd("C:/Users/X-Note/Desktop")
wind = read.table("wind.txt", header = T)
head(wind)
```


(b) 변수 W, T, V 사이의 선형회귀모형을 적합하여라. 잔차들의 패턴을 검토하여 선형모형의 적절성 여부를 조사하여라.
+ 문제에서 실제온도(T)와 풍속(V) 하에서 바람으로 인해 일어나는 냉각효과가 반영된 체감온도(W)라고 하였기에 원인을 온도와 풍속, 결과를 체감온도로 두고 선형회귀모형을 적합해보겠다.
```{r}
lm_wind = lm(W ~ T + V, data = wind)
summary(lm_wind)
plot(rstandard(lm_wind), xlab = "적합값", ylab = "잔차", pch = 16)
```

+ 회귀 적합 결과, 모든 회귀계수에 대하여 p-value가 0에 수렴하는 매우 작은 수이므로 유의한 회귀계수라고 할 수 있다.

+ 표준화잔차 대 적합값의 플롯을 그려보니 적합값이 커짐에 따라 좁은 깔때기 모양으로 모였다가 특정 기점을 기준으로 넓은 깔때기 모양으로 퍼지는 형태가 나왔다. 이를 통해 현재 적합한 lm_wind에서는 이분산성이 나타나며 등분산성을 만족하지 않음을 알 수 있다.

(c) T의 효과에 대하여 W를 조정한 후(즉, T를 고정시킨 상태에서) W와 V 사이의 관계를 살펴보아라. 이들 두 변수 사이의 관계가 선형적인가?
```{r}
lm_wind_v = lm(W ~ T + sqrt(V), data = wind)
summary(lm_wind_v)
plot(rstandard(lm_wind_v), xlab = "적합값", ylab = "잔차", pch = 16)
```

+ 회귀 적합 결과, 모든 회귀계수에 대하여 p-value가 0에 수렴하는 매우 작은 수이므로 유의한 회귀계수라고 할 수 있다. 결정계수 값은 0.9811로 매우 높은 수치이다.
+ 포아송 분포 변환으로 변수를 변환해보았는데, 원 데이터의 표준화잔차와 마찬가지로 특정한 깔때기 형태를 띠어 이분산적이라고 할 수 있다.
+ 위의 결과를 통해 통계적 수치적으로는 유의하나 등분산성을 만족하지 않으므로 선형적이라고 할 수 없다.

(d) V의 효과에 대하여 W를 조정한 후 W와 T 사이의 관계를 살펴보아라. 이들 두 변수 사이의 관계가 선형적인가?
```{r}
lm_wind_t = lm(W ~ V + sqrt(T), data = wind)
summary(lm_wind_t)
plot(rstandard(lm_wind_t), xlab = "적합값", ylab = "잔차", pch = 16)
```

+ 회귀 적합 결과, 모든 회귀계수에 대하여 p-value가 0에 수렴하는 매우 작은 수이므로 유의한 회귀계수라고 할 수 있다. 결정계수 값은 0.8831로 (c)의 모형보다는 다소 떨어진다.  
+ (c)번과 마찬가지로 포아송 분포 변환으로 변수를 변환하였는데 원 데이터의 표준화잔차의 형태와는 다르지만 이차곡선이 일정한 주기 내에서 반복되는 형태를 띤다.
+ 위의 결과를 통해 통계적 수치적으로는 유의하고 이분산성을 보이지는 않지만 잔차들이 이차곡선 모양을 보이므로 선형적이라고 할 수 없다.

(e) 다음 모형을 적합하여라. 
$$W = \beta_0 + \beta_1T + \beta_2V + \beta_3\sqrt(V) + \epsilon$$ - (6.18)
이 모형의 적합이 적절하게 나타나고 있는가? W 값은 국립기상국에서 다음 공식(반올림에 따른 오차는 제외)을 사용하여 얻은 것이다. 
$$W = 0.0817(3.71\sqrt(V) + 5.81 - 0.25V)(T - 91.4) + 91.4$$ - (6.19) 
이 공식의 정확도를 주어진 데이터를 통해 검토하여라.
```{r}
lm_wind_v2 = lm(W ~ T + V + sqrt(V), data = wind)
summary(lm_wind_v2)
```

+ 회귀 적합 결과, 모든 회귀계수에 대하여 p-value가 0에 수렴하는 매우 작은 수이므로 유의한 회귀계수라고 할 수 있다.
결정계수 값은 0.9856으로 매우 높은 수치이다. 이 적합을 통해 나온 회귀 적합식은 다음과 같다. $$W = 48.91 + 1.42T + 1.65V - 26.62\sqrt(V)$$

(f) 식 (6.18), (6.19)에 있는 모형들보다 더 좋은 모형을 제안할 수 있는가?
+ 포아송 변환이 아닌 다양한 다른 변수변환법을 활용한다면 이보다 더 좋은 모형이 나올 수도 있을 것이다.
